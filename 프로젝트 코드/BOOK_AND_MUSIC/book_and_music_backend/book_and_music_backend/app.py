from flask_cors import CORS
from flask import Flask, request, jsonify
import threading
import os
import requests
import openai
import re
from dotenv import load_dotenv

load_dotenv()
app = Flask(__name__)
CORS(app)

SPOTIFY_USER_ID = os.getenv("SPOTIFY_USER_ID")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
openai.api_key = OPENAI_API_KEY

# ğŸ” ì¸ì¦
def refresh_access_token():
    response = requests.post(
        "https://accounts.spotify.com/api/token",
        data={
            "grant_type": "refresh_token",
            "refresh_token": os.getenv("SPOTIFY_REFRESH_TOKEN"),
            "client_id": os.getenv("SPOTIFY_CLIENT_ID"),
            "client_secret": os.getenv("SPOTIFY_CLIENT_SECRET"),
        }
    )
    if response.status_code == 200:
        return response.json()["access_token"]
    raise Exception("âŒ Access Token ê°±ì‹  ì‹¤íŒ¨: " + response.text)

def get_headers():
    token = refresh_access_token()
    return {"Authorization": f"Bearer {token}"}

# ğŸµ GPTì—ê²Œ ì§ˆë¬¸
def ask_chatgpt_for_playlist(prompt):
    response = openai.chat.completions.create(
        model="gpt-4-turbo", # 3.5ë„ ê°€ëŠ¥. ì‹œì—°ì˜ìƒì—ì„œëŠ” 3.5ì‚¬ìš©
        messages=[
            {"role": "system", "content": "You're a music playlist assistant."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.7
    )
    return response.choices[0].message.content

# ğŸ§ Spotify ê´€ë ¨
def search_track_uri(track_name):
    url = "https://api.spotify.com/v1/search"
    headers = get_headers()
    params = {"q": track_name, "type": "track", "limit": 1}
    r = requests.get(url, headers=headers, params=params)
    items = r.json().get("tracks", {}).get("items", [])
    return items[0]["uri"] if items else None

def create_spotify_playlist(name, description="Generated by ChatGPT"):
    url = f"https://api.spotify.com/v1/users/{SPOTIFY_USER_ID}/playlists"
    headers = get_headers()
    body = {"name": name, "description": description, "public": False}
    r = requests.post(url, headers=headers, json=body)
    if r.status_code == 201:
        return r.json()["id"]
    raise Exception("âŒ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨!")

def add_tracks_to_playlist(playlist_id, uris):
    url = f"https://api.spotify.com/v1/playlists/{playlist_id}/tracks"
    headers = get_headers()
    r = requests.post(url, headers=headers, json={"uris": uris})
    return r.status_code == 201 or r.status_code == 200

# ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸
@app.route("/generate_playlist", methods=["POST"]) # POSTí˜•ì‹ìœ¼ë¡œ ë°›ì•„ì˜´
def generate_playlist():
    data = request.get_json()

    book_title = data.get("book_title", "") # ì±… ì œëª©
    story = data.get("book_story") # ì¤„ê±°ë¦¬ (c++ë¶€ë¶„ì—ì„œ ifë¬¸ í˜•íƒœë¡œ ë°›ì•„ì™”ì—ˆìŒ)


    print(f"ğŸ“˜ ì±… ì œëª©: {book_title}") # í”„ë¡¬í”„íŠ¸ í™•ì¸ìš© ì¶œë ¥
    print(f"ğŸ“ ìš”ì•½: {story}")

    prompt = (f"'{book_title}'ì´ë¼ëŠ” ì±…ì— ëŒ€í•´ ì•Œë ¤ì¤„ê²Œ.\n"
    f"ìš”ì•½ ì¤„ê±°ë¦¬:\n{story}\n\n"
    f"ì´ ì±…ì˜ ë°°ê²½ê³¼ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì–´ìš¸ë¦¬ëŠ” ë…¸ë˜ 5ê³¡ì„ ì¶”ì²œí•´ì¤˜.")
    playlist_name = f"{book_title} í”Œë ˆì´ë¦¬ìŠ¤íŠ¸"

    # GPTë¡œ ë…¸ë˜ ì¶”ì²œë°›ê¸°
    songs = ask_chatgpt_for_playlist(prompt)
    print("ğŸ’¬ GPT ì¶”ì²œ ê²°ê³¼:\n", songs)

    # ë…¸ë˜ ëª©ë¡ ì •ë¦¬
    import re
    # GPTê°€ ì¶”ì²œí•œ ë…¸ë˜ ëª©ë¡ì—ì„œ ìˆ«ì(ì˜ˆ: 1. ~, 2. ~) ì œê±° í›„, ê³µë°±ê³¼ ë”°ì˜´í‘œ ì •ë¦¬
    song_lines = [re.sub(r'^[0-9]+\.\s*', '', line).strip('" ') for line in songs.split("\n") if line.strip()]
    # ê° ë…¸ë˜ ì œëª©ì— ëŒ€í•´ Spotifyì—ì„œ ê²€ìƒ‰í•´ íŠ¸ë™ URI ê°€ì ¸ì˜¤ê¸°
    track_uris = [search_track_uri(song) for song in song_lines if song]
    # ê²€ìƒ‰ ê²°ê³¼ ì¤‘ Noneì´ ì•„ë‹Œ ìœ íš¨í•œ URIë§Œ í•„í„°ë§
    track_uris = [uri for uri in track_uris if uri]

    # âœ… playlist_id ì •ì˜ í•„ìš”!
    playlist_id = create_spotify_playlist(playlist_name)
    add_tracks_to_playlist(playlist_id, track_uris)

    print(f"âœ… '{playlist_name}' í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ!")

    return jsonify({ # ë‹¤ì‹œ ê²°ê³¼ QTì— ì „ë‹¬ 
        "status": "success",
        "playlist_url": f"https://open.spotify.com/playlist/{playlist_id}"
    })



if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5050)


